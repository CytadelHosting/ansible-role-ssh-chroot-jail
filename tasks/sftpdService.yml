---
# =============================================================================
# Installation du service SSHD jail (sshd@jail)
# =============================================================================

# -----------------------------------------------------------------------------
# Installation du service template systemd
# -----------------------------------------------------------------------------
- name: Copy sshd@ service template to /lib/systemd/system/
  copy:
    src: sshd@.service
    dest: /lib/systemd/system/sshd@.service
    owner: root
    group: root
    mode: '0644'
  notify:
    - reload systemd daemon
    - restart sshd jail daemon

- name: Create symlink in /etc/systemd/system/
  file:
    src: /lib/systemd/system/sshd@.service
    dest: /etc/systemd/system/sshd@.service
    state: link
  notify:
    - reload systemd daemon

# -----------------------------------------------------------------------------
# Configuration SSHD pour jail
# -----------------------------------------------------------------------------
- name: Deploy sshd_config for jail service
  template:
    src: sshd_config_jail.j2
    dest: "/etc/ssh/sshd_config_{{ ssh_chroot_service_name }}"
    owner: root
    group: root
    mode: '0600'
    validate: '/usr/sbin/sshd -t -f %s'
  notify:
    - restart sshd jail daemon

# -----------------------------------------------------------------------------
# Activation et d√©marrage du service
# -----------------------------------------------------------------------------
- name: Ensure sshd@jail service is enabled and started
  systemd:
    name: "{{ sshd_jail_daemon }}"
    enabled: true
    state: started
    daemon_reload: true
