---
# =============================================================================
# Installation du service SSHD jail (sshd@jail)
# =============================================================================

# -----------------------------------------------------------------------------
# Nettoyage d'éventuels symlinks résiduels
# -----------------------------------------------------------------------------
- name: Remove any residual symlink in /etc/systemd/system/
  file:
    path: /etc/systemd/system/sshd@.service
    state: absent
  register: symlink_removed

# -----------------------------------------------------------------------------
# Installation du service template systemd
# -----------------------------------------------------------------------------
# Vérifier si le fichier existe déjà (fourni par openssh-server sur certaines distros)
- name: Check if sshd@.service already exists
  stat:
    path: /lib/systemd/system/sshd@.service
  register: sshd_template_exists

- name: Copy sshd@ service template to /lib/systemd/system/
  copy:
    src: sshd@.service
    dest: /lib/systemd/system/sshd@.service
    owner: root
    group: root
    mode: '0644'
  register: sshd_service_file
  when: not sshd_template_exists.stat.exists

# Reload systemd immédiatement si quelque chose a changé
- name: Reload systemd daemon after service file change
  systemd:
    daemon_reload: true
  when: sshd_service_file.changed | default(false) or symlink_removed.changed

# -----------------------------------------------------------------------------
# Configuration SSHD pour jail
# -----------------------------------------------------------------------------
- name: Deploy sshd_config for jail service
  template:
    src: sshd_config_jail.j2
    dest: "/etc/ssh/sshd_config_{{ ssh_chroot_service_name }}"
    owner: root
    group: root
    mode: '0600'
    validate: '/usr/sbin/sshd -t -f %s'
  notify:
    - restart sshd jail daemon

# -----------------------------------------------------------------------------
# Activation et démarrage du service
# -----------------------------------------------------------------------------
- name: Ensure sshd@jail service is enabled and started
  systemd:
    name: "{{ sshd_jail_daemon }}"
    enabled: true
    state: started
    daemon_reload: true
