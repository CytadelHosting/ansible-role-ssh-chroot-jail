---
# =============================================================================
# Création d'une jail individuelle pour un utilisateur
# =============================================================================
# Variable attendue : jail_user (dictionnaire avec name, home, etc.)
# Ce fichier est inclus depuis jail-user.yml pour chaque utilisateur
#
# OPTIMISATION : Les binaires communs sont copiés depuis /jails/base via rsync
#                Seuls les extra_bins spécifiques sont copiés individuellement

# -----------------------------------------------------------------------------
# Création de l'arborescence de la jail
# -----------------------------------------------------------------------------
- name: "{{ jail_user.name }} | Create jail root directory"
  file:
    path: "{{ ssh_chroot_jail_path }}/{{ jail_user.name }}"
    owner: root
    group: root
    mode: '0755'
    state: directory

# -----------------------------------------------------------------------------
# Copie optimisée depuis /jails/base (binaires + libs + terminfo + NSS)
# -----------------------------------------------------------------------------
- name: "{{ jail_user.name }} | Check if jail already has binaries"
  stat:
    path: "{{ ssh_chroot_jail_path }}/{{ jail_user.name }}/bin/bash"
  register: jail_has_bins

- name: "{{ jail_user.name }} | Sync from base jail (fast copy)"
  shell: |
    rsync -a --ignore-existing \
      {{ ssh_chroot_jail_path }}/base/ \
      {{ ssh_chroot_jail_path }}/{{ jail_user.name }}/
  when: not jail_has_bins.stat.exists
  changed_when: true

# Forcer la resync si demandé globalement
- name: "{{ jail_user.name }} | Force resync from base jail"
  shell: |
    rsync -a \
      {{ ssh_chroot_jail_path }}/base/ \
      {{ ssh_chroot_jail_path }}/{{ jail_user.name }}/
  when: ssh_chroot_jail_sync_bins | default(false)
  changed_when: true

# -----------------------------------------------------------------------------
# Création des répertoires manquants (au cas où)
# -----------------------------------------------------------------------------
# Note: PAS de recurse ici pour éviter de suivre les bind mounts existants
- name: "{{ jail_user.name }} | Ensure jail subdirectories exist"
  file:
    path: "{{ ssh_chroot_jail_path }}/{{ jail_user.name }}/{{ item }}"
    state: directory
  loop: "{{ ssh_chroot_jail_dirs }}"

- name: "{{ jail_user.name }} | Set tmp directory permissions (sticky bit)"
  file:
    path: "{{ ssh_chroot_jail_path }}/{{ jail_user.name }}/tmp"
    mode: '1777'
    state: directory

# -----------------------------------------------------------------------------
# Création des devices dans la jail (ne peuvent pas être copiés)
# -----------------------------------------------------------------------------
- name: "{{ jail_user.name }} | Create jail devices"
  command: >
    mknod -m 0666 
    {{ ssh_chroot_jail_path }}/{{ jail_user.name }}/dev/{{ item.dev }} 
    {{ item.type | default('c') }} 
    {{ item.major }} 
    {{ item.minor }}
  args:
    creates: "{{ ssh_chroot_jail_path }}/{{ jail_user.name }}/dev/{{ item.dev }}"
  loop: "{{ ssh_chroot_jail_devs }}"

# -----------------------------------------------------------------------------
# Copie des binaires EXTRA spécifiques à l'utilisateur (si définis)
# -----------------------------------------------------------------------------
- name: "{{ jail_user.name }} | Copy user-specific extra binaries"
  copy:
    src: "{{ item.bin | default(item) }}"
    dest: "{{ ssh_chroot_jail_path }}/{{ jail_user.name }}{{ item.bin | default(item) }}"
    remote_src: true
    mode: "{{ item.mode | default('0755') }}"
  loop: "{{ jail_user.extra_bins | default([]) }}"
  when: jail_user.extra_bins is defined and jail_user.extra_bins | length > 0
  ignore_errors: '{{ ansible_check_mode }}'

- name: "{{ jail_user.name }} | Copy extra binary libraries via l2chroot"
  command: "{{ ssh_chroot_l2chroot_path }} {{ item.bin | default(item) }}"
  environment:
    BASE: "{{ ssh_chroot_jail_path }}/{{ jail_user.name }}"
  loop: "{{ jail_user.extra_bins | default([]) }}"
  when: jail_user.extra_bins is defined and jail_user.extra_bins | length > 0
  changed_when: false
  ignore_errors: '{{ ansible_check_mode }}'

# -----------------------------------------------------------------------------
# Fichiers /etc minimaux dans la jail (avec owners des bind mounts)
# -----------------------------------------------------------------------------
# Récupérer les infos des owners/groups des dossiers sources des bind mounts
- name: "{{ jail_user.name }} | Get bind mount source directories info"
  stat:
    path: "{{ bind.src_dir }}"
  loop: "{{ jail_user.bind_remounts | default([]) }}"
  loop_control:
    loop_var: bind
  register: bind_stats
  when: jail_user.bind_remounts is defined

# Construire la liste des uid/gid uniques des bind mounts
- name: "{{ jail_user.name }} | Build list of bind mount owners"
  set_fact:
    _bind_owners: "{{ bind_stats.results | default([]) | selectattr('stat', 'defined') | map(attribute='stat') | list }}"
  when: jail_user.bind_remounts is defined

- name: "{{ jail_user.name }} | Get owner names for bind mounts"
  shell: "getent passwd {{ item.uid }} | cut -d: -f1,3,4,6,7"
  loop: "{{ _bind_owners | default([]) }}"
  register: bind_owner_names
  changed_when: false
  failed_when: false
  when: 
    - _bind_owners is defined
    - _bind_owners | length > 0

- name: "{{ jail_user.name }} | Get group names for bind mounts"
  shell: "getent group {{ item.gid }} | cut -d: -f1,3"
  loop: "{{ _bind_owners | default([]) }}"
  register: bind_group_names
  changed_when: false
  failed_when: false
  when:
    - _bind_owners is defined
    - _bind_owners | length > 0

# Générer /etc/passwd avec root + user jail + owners des bind mounts
- name: "{{ jail_user.name }} | Generate /etc/passwd content"
  set_fact:
    _jail_passwd_content: |
      root:x:0:0:root:/root:/bin/bash
      {{ jail_user.name }}:x:{{ jail_user_info.uid }}:{{ jail_user_info.group }}:{{ jail_user.name }}:{{ jail_user.home }}:{{ _user_shell }}
      {% for result in bind_owner_names.results | default([]) %}
      {% if result.stdout is defined and result.stdout != '' %}
      {% set parts = result.stdout.split(':') %}
      {% if parts[0] != jail_user.name and parts[0] != 'root' %}
      {{ parts[0] }}:x:{{ parts[1] }}:{{ parts[2] }}:{{ parts[0] }}:{{ parts[3] | default('/nonexistent') }}:{{ parts[4] | default('/usr/sbin/nologin') }}
      {% endif %}
      {% endif %}
      {% endfor %}

- name: "{{ jail_user.name }} | Create /etc/passwd in jail"
  copy:
    content: "{{ _jail_passwd_content }}"
    dest: "{{ ssh_chroot_jail_path }}/{{ jail_user.name }}/etc/passwd"
    owner: root
    group: root
    mode: '0644'

# Générer /etc/group avec root + user group + groups des bind mounts
- name: "{{ jail_user.name }} | Generate /etc/group content"
  set_fact:
    _jail_group_content: |
      root:x:0:
      {{ _user_group_name }}:x:{{ jail_user_info.group }}:
      {% for result in bind_group_names.results | default([]) %}
      {% if result.stdout is defined and result.stdout != '' %}
      {% set parts = result.stdout.split(':') %}
      {% if parts[1] != jail_user_info.group and parts[1] != '0' %}
      {{ parts[0] }}:x:{{ parts[1] }}:
      {% endif %}
      {% endif %}
      {% endfor %}

- name: "{{ jail_user.name }} | Create /etc/group in jail"
  copy:
    content: "{{ _jail_group_content }}"
    dest: "{{ ssh_chroot_jail_path }}/{{ jail_user.name }}/etc/group"
    owner: root
    group: root
    mode: '0644'

# -----------------------------------------------------------------------------
# Home directory dans la jail
# -----------------------------------------------------------------------------
- name: "{{ jail_user.name }} | Create home directory in jail"
  file:
    path: "{{ ssh_chroot_jail_path }}/{{ jail_user.name }}{{ jail_user.home }}"
    state: directory
    owner: "{{ jail_user.name }}"
    group: "{{ jail_user.group | default(jail_user.name) }}"
    mode: '0755'

- name: "{{ jail_user.name }} | Copy skeleton files to jail home"
  command: "cp -r -n /etc/skel/. {{ ssh_chroot_jail_path }}/{{ jail_user.name }}{{ jail_user.home }}"
  become: true
  become_user: "{{ jail_user.name }}"
  failed_when: false
  changed_when: false
