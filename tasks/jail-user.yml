---
# =============================================================================
# Gestion d'un utilisateur jailed
# =============================================================================
# Variable attendue : jail_user (dictionnaire)
# Format :
#   - name: alice
#     home: /home_local/alice
#     allow_interactive: false
#     authorized_keys: [...]
#     extra_bins: []
#     bind_remounts: [...]
#     ssh_match_options: {}

# -----------------------------------------------------------------------------
# Calcul du shell et du groupe en fonction de allow_interactive
# -----------------------------------------------------------------------------
- name: "{{ jail_user.name }} | Determine shell based on allow_interactive"
  set_fact:
    _user_shell: "{{ '/bin/bash' if (jail_user.allow_interactive | default(false)) else '/usr/sbin/nologin' }}"
    _user_group: "{{ ssh_chroot_jail_group_name if (jail_user.allow_interactive | default(false)) else sftp_chroot_jail_group_name }}"

# -----------------------------------------------------------------------------
# Gestion du mot de passe (optionnel)
# -----------------------------------------------------------------------------
- name: "{{ jail_user.name }} | Set password (encrypted or disabled)"
  set_fact:
    _user_password: "{{ jail_user.password | default('!') }}"

- name: "{{ jail_user.name }} | Compute password from plain_password if provided"
  set_fact:
    _user_password: "{{ jail_user.plain_password | password_hash('sha512', jail_user.password_salt | default('C8reC.Xc')) }}"
  when:
    - jail_user.plain_password is defined
    - jail_user.plain_password != ''

# -----------------------------------------------------------------------------
# Création de l'utilisateur système
# -----------------------------------------------------------------------------
# D'abord retirer l'utilisateur de l'autre groupe jail (mutuellement exclusifs)
- name: "{{ jail_user.name }} | Remove from opposite jail group"
  command: "gpasswd -d {{ jail_user.name }} {{ _opposite_group }}"
  vars:
    _opposite_group: "{{ sftp_chroot_jail_group_name if (jail_user.allow_interactive | default(false)) else ssh_chroot_jail_group_name }}"
  register: gpasswd_result
  failed_when: false
  changed_when: gpasswd_result.rc == 0


- name: "{{ jail_user.name }} | Ensure system user exists"
  user:
    name: "{{ jail_user.name }}"
    password: "{{ _user_password }}"
    group: "{{ jail_user.group | default(omit) }}"
    groups: "{{ _user_group }}"
    append: true
    shell: "{{ _user_shell }}"
    home: "{{ jail_user.home | default(omit) }}"
    create_home: "{{ jail_user.create_home | default(true) }}"
    state: present
  register: user_created

# -----------------------------------------------------------------------------
# Récupération des infos utilisateur (uid/gid)
# -----------------------------------------------------------------------------
- name: "{{ jail_user.name }} | Get user info"
  getent:
    database: passwd
    key: "{{ jail_user.name }}"

- name: "{{ jail_user.name }} | Store user info"
  set_fact:
    jail_user_info:
      uid: "{{ getent_passwd[jail_user.name][1] }}"
      group: "{{ getent_passwd[jail_user.name][2] }}"

- name: "{{ jail_user.name }} | Get group name"
  getent:
    database: group
    key: "{{ jail_user_info.group }}"
  register: group_info_result
  failed_when: false

- name: "{{ jail_user.name }} | Store group name"
  set_fact:
    _user_group_name: "{{ jail_user.group | default(jail_user.name) }}"

# -----------------------------------------------------------------------------
# Gestion des clés SSH autorisées (dans le home RÉEL, pas la jail)
# -----------------------------------------------------------------------------
- name: "{{ jail_user.name }} | Add authorized SSH public keys"
  authorized_key:
    user: "{{ jail_user.name }}"
    key: "{{ lookup('file', pubkey_file) }}"
    state: present
  loop: "{{ jail_user.authorized_keys | default([]) }}"
  loop_control:
    loop_var: pubkey_file
  when: jail_user.authorized_keys is defined
  ignore_errors: "{{ ansible_check_mode }}"

# -----------------------------------------------------------------------------
# Création de la jail individuelle
# -----------------------------------------------------------------------------
- include_tasks: createJail.yml

# -----------------------------------------------------------------------------
# Configuration des bind mounts
# -----------------------------------------------------------------------------
# Vérifier quels mount points sont déjà montés (pour éviter les erreurs sur fs ro)
- name: "{{ jail_user.name }} | Check existing mounts"
  shell: "mount | grep -q '{{ ssh_chroot_jail_path }}/{{ jail_user.name }}{{ bind.mount_point | default(bind.src_dir) }}' && echo 'mounted' || echo 'not_mounted'"
  loop: "{{ jail_user.bind_remounts | default([]) }}"
  loop_control:
    loop_var: bind
  register: _mount_check
  changed_when: false
  failed_when: false

# Créer les répertoires de mount point SEULEMENT s'ils ne sont pas déjà montés
- name: "{{ jail_user.name }} | Ensure bind mount directories exist in jail"
  file:
    path: "{{ ssh_chroot_jail_path }}/{{ jail_user.name }}{{ item.bind.mount_point | default(item.bind.src_dir) }}"
    state: directory
    owner: "{{ jail_user.name }}"
    group: "{{ jail_user.group | default(jail_user.name) }}"
    mode: '0755'
  loop: "{{ _mount_check.results }}"
  when: item.stdout == 'not_mounted'

- name: "{{ jail_user.name }} | Mount bind directories"
  mount:
    path: "{{ ssh_chroot_jail_path }}/{{ jail_user.name }}{{ bind.mount_point | default(bind.src_dir) }}"
    src: "{{ bind.src_dir }}"
    fstype: 'none'
    opts: "defaults,bind,{{ 'rw' if (bind.rw | default(false)) else 'ro' }}"
    state: "{{ bind.state | default('mounted') }}"
  loop: "{{ jail_user.bind_remounts | default([]) }}"
  loop_control:
    loop_var: bind

# -----------------------------------------------------------------------------
# Configuration des ACL pour les bind mounts en écriture
# -----------------------------------------------------------------------------
# Applique les ACL sur le dossier SOURCE pour permettre à l'utilisateur jailed
# d'écrire dans les bind mounts configurés en rw
- name: "{{ jail_user.name }} | Set ACL on bind mount source directories (rwX)"
  acl:
    path: "{{ bind.src_dir }}"
    entity: "{{ jail_user.name }}"
    etype: user
    permissions: rwX
    recursive: true
    state: present
  loop: "{{ jail_user.bind_remounts | default([]) }}"
  loop_control:
    loop_var: bind
  when:
    - bind.rw | default(false)
    - bind.state | default('mounted') != 'absent'

# ACL par défaut pour les nouveaux fichiers/dossiers créés
- name: "{{ jail_user.name }} | Set default ACL on bind mount source directories"
  acl:
    path: "{{ bind.src_dir }}"
    entity: "{{ jail_user.name }}"
    etype: user
    permissions: rwX
    default: true
    recursive: true
    state: present
  loop: "{{ jail_user.bind_remounts | default([]) }}"
  loop_control:
    loop_var: bind
  when:
    - bind.rw | default(false)
    - bind.state | default('mounted') != 'absent'
