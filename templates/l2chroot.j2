#!/bin/bash
# =============================================================================
# l2chroot - Copie les librairies partagées d'un binaire dans une jail
# =============================================================================
# Usage : l2chroot /path/to/binary
#
# La variable d'environnement BASE définit le chemin de la jail cible.
# Si BASE n'est pas définie, utilise le chemin par défaut.
#
# Source originale : nixCraft - http://www.cyberciti.biz/tips/
# Modifié pour support multi-jail
# =============================================================================

# Chemin de base de la jail (peut être surchargé via variable d'env BASE)
JAIL="${BASE:-{{ ssh_chroot_jail_path }}}"

if [ $# -eq 0 ]; then
    echo "Usage: $0 /path/to/executable"
    echo "       BASE=/jails/alice $0 /usr/bin/vim"
    exit 1
fi

BINARY="$1"

if [ ! -x "$BINARY" ]; then
    echo "Erreur: $BINARY n'est pas un exécutable valide"
    exit 1
fi

[ ! -d "$JAIL" ] && mkdir -p "$JAIL"

# Récupération des librairies partagées (hors ld-linux)
FILES=$(ldd "$BINARY" 2>/dev/null | awk '{ print $3 }' | grep -E '^/')

echo "Copie des librairies de $BINARY vers $JAIL..."

for lib in $FILES; do
    if [ -f "$lib" ]; then
        dir=$(dirname "$lib")
        [ ! -d "$JAIL$dir" ] && mkdir -p "$JAIL$dir"
        cp -n "$lib" "$JAIL$dir/" 2>/dev/null
    fi
done

# Copie du loader ld-linux
LDLINUX=$(ldd "$BINARY" 2>/dev/null | grep 'ld-linux' | awk '{ print $1 }')

if [ -n "$LDLINUX" ] && [ -f "$LDLINUX" ]; then
    lddir=$(dirname "$LDLINUX")
    [ ! -d "$JAIL$lddir" ] && mkdir -p "$JAIL$lddir"
    if [ ! -f "$JAIL$LDLINUX" ]; then
        echo "Copie de $LDLINUX..."
        cp "$LDLINUX" "$JAIL$lddir/"
    fi
fi

echo "Terminé."
